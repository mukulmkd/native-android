plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
    id 'com.facebook.react'
}

react {
    root = file("../js")
    cliFile = file("../js/node_modules/react-native/cli.js")
    hermesCommand = "../js/node_modules/react-native/sdks/hermesc/%OS-BIN%/hermesc"
    reactNativeDir = file("../js/node_modules/react-native")
}

android {
    namespace 'com.dummyapp.nativeandroid'
    compileSdk 34

    defaultConfig {
        applicationId 'com.dummyapp.nativeandroid'
        minSdk 24
        targetSdk 34
        versionCode 1
        versionName '1.0'
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }

    kotlinOptions {
        jvmTarget = '17'
    }

    packagingOptions {
        jniLibs {
            useLegacyPackaging = true
        }
    }

    buildFeatures {
        buildConfig = true
    }
}

// Task to regenerate autolinking config before build
tasks.register('generateAutolinkingConfig', Exec) {
    group = 'react'
    description = 'Generate autolinking.json from react-native config'
    workingDir = project.rootDir
    commandLine = ['bash', 'scripts/generate-autolinking-config.sh']
    doFirst {
        // Ensure output directory exists
        mkdir("${project.rootDir}/build/generated/autolinking")
    }
}

// Make autolinking tasks depend on config generation
tasks.named('generateAutolinkingPackageList').configure {
    dependsOn('generateAutolinkingConfig')
    doLast {
        // Remove AsyncStorage and ExpoModulesPackage from generated PackageList
        // AsyncStorage has compilation issues with Kotlin dependencies (Room, etc.)
        // ExpoModulesPackage is not needed (expo is only in devDependencies for Metro bundling)
        // TODO: Properly link AsyncStorage to enable persistence
        def packageListFile = file("${project.buildDir}/generated/autolinking/src/main/java/com/facebook/react/PackageList.java")
        if (packageListFile.exists()) {
            def content = packageListFile.text
            // Remove AsyncStorage import
            content = content.replaceAll('import com\\.reactnativecommunity\\.asyncstorage\\.AsyncStoragePackage;', '// AsyncStorage removed - has compilation issues with Kotlin dependencies')
            // Remove AsyncStoragePackage() from the list
            content = content.replaceAll(',\\s*new AsyncStoragePackage\\(\\)', '')
            // Remove ExpoModulesPackage import
            content = content.replaceAll('import expo\\.modules\\.ExpoModulesPackage;', '// ExpoModulesPackage removed - expo is only in devDependencies for Metro bundling')
            // Remove ExpoModulesPackage() from the list
            content = content.replaceAll(',\\s*new ExpoModulesPackage\\(\\)', '')
            packageListFile.text = content
        }
    }
}

dependencies {
    implementation 'androidx.core:core-ktx:1.13.1'
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'com.google.android.material:material:1.11.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
    implementation 'androidx.recyclerview:recyclerview:1.3.2'
    implementation 'androidx.cardview:cardview:1.0.0'
    implementation "com.facebook.react:react-android:0.81.5"
    implementation "com.facebook.react:hermes-android:0.81.5"
    // Add AsyncStorage dependencies that are needed at runtime
    // Note: AsyncStorage native module is manually registered in MainApplication.kt
    // The JavaScript side will work, but native module needs to be available
}

